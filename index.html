<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect DEBUG MODE</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        :root { --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; --bg-primary: #fff; --bg-secondary: #f0f2f5; --text-primary: #1c1e21; --accent: #8A2BE2; --user-bubble: #8A2BE2; --partner-bubble: #fff; --user-text: #fff; --partner-text: #1c1e21; }
        body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: var(--font-sans); background-color: var(--bg-secondary); color: var(--text-primary); }
        #app { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; max-width: 600px; margin: 0 auto; background-color: var(--bg-primary); }
        .screen { display: none !important; flex-direction: column; height: 100%; width: 100%; }
        .screen.active { display: flex !important; }
        .header { flex-shrink: 0; padding: 1rem; border-bottom: 1px solid #e4e6eb; display:flex; justify-content:space-between; align-items:center; height: 50px;}
        .screen-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .card { background: #fff; padding: 1rem; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        input { width: 100%; padding: 0.7rem; margin-bottom: 0.5rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 1rem; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        #message-area { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; background: var(--bg-secondary); }
        .message-row { display: flex; } .message-row.user { justify-content: flex-end; }
        .message-bubble { padding: 0.6rem 0.8rem; border-radius: 12px; max-width: 70%; word-wrap: break-word; }
        .message-row.user .message-bubble { background: var(--user-bubble); color: var(--user-text); }
        .message-row.partner .message-bubble { background: var(--partner-bubble); color: var(--partner-text); }
        .chat-footer { padding: 0.5rem; display: flex; gap: 0.5rem; border-top: 1px solid #ddd; }
    </style>
</head>
<body>
    <div id="app">
        <div id="login-screen" class="screen active">
            <div class="screen-content" style="text-align: center; justify-content: center; display: flex; flex-direction: column;">
                <h1>Connect (Debug)</h1>
                <button id="login-btn">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            </div>
        </div>
        <div id="setup-screen" class="screen">
            <header class="header"><h1>í”„ë¡œí•„ ì„¤ì •</h1></header>
            <div class="screen-content">
                <div class="card">
                    <input type="text" id="persona-name-input" placeholder="ì´ë¦„">
                    <input type="password" id="api-key-input" placeholder="API Key">
                </div>
                <button id="start-chat-btn">ì‹œì‘í•˜ê¸°</button>
                <button id="reset-btn" style="background: red; margin-top:10px;">ë°ì´í„° ì´ˆê¸°í™” (ë¬¸ì œí•´ê²°ìš©)</button>
            </div>
        </div>
        <div id="chat-screen" class="screen">
            <header class="header">
                <h2 id="chat-header-title">Chat</h2>
                <button id="logout-btn" style="width:auto; padding:0.5rem;">ë¡œê·¸ì•„ì›ƒ</button>
            </header>
            <main id="message-area"></main>
            <footer class="chat-footer">
                <input type="text" id="message-input">
                <button id="send-btn" style="width: 50px;">â¤</button>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const firebaseConfig = { apiKey: "AIzaSyDmO1wpZQJEiPEjNoq7xtFcq33akIzoGY8", authDomain: "aimeet-c235c.firebaseapp.com", projectId: "aimeet-c235c", appId: "1:732324287861:web:15d894068755c627842f3c" };
        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        
        let userState = { uid: null, apiKey: null, persona: {}, history: [] };
        let startChatCount = 0; // [ë””ë²„ê·¸] í˜¸ì¶œ íšŸìˆ˜ ì¹´ìš´í„°

        const el = (id) => document.getElementById(id);
        const showScreen = (id) => {
            console.log(`ğŸš€ [ë””ë²„ê·¸] í™”ë©´ ì´ë™: ${id}`);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            el(id).classList.add('active');
        };

        // ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ
        function displayMessage(role, text) {
            const row = document.createElement('div');
            row.className = `message-row ${role === 'user' ? 'user' : 'partner'}`;
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            row.appendChild(bubble);
            el('message-area').appendChild(row);
            el('message-area').scrollTop = el('message-area').scrollHeight;
        }

        // [í•µì‹¬ ë””ë²„ê·¸] ì±„íŒ… ì‹œì‘ í•¨ìˆ˜
        async function startChat() {
            startChatCount++;
            console.log(`ğŸš€ [ë””ë²„ê·¸] startChat ì‹¤í–‰ë¨ (ëˆ„ì  íšŸìˆ˜: ${startChatCount})`);
            
            if (startChatCount > 5) {
                console.error("ğŸš¨ [ê²½ê³ ] startChatì´ ë„ˆë¬´ ë§ì´ í˜¸ì¶œë˜ê³  ìˆìŠµë‹ˆë‹¤! ë¬´í•œ ë£¨í”„ ì˜ì‹¬.");
                return; 
            }

            try {
                const now = Date.now();
                const threeDaysAgo = now - (3 * 24 * 60 * 60 * 1000);
                
                // [ë””ë²„ê·¸] ì „ì²´ íˆìŠ¤í† ë¦¬ ê°œìˆ˜ í™•ì¸
                console.log(`ğŸš€ [ë””ë²„ê·¸] ì „ì²´ íˆìŠ¤í† ë¦¬ ê°œìˆ˜: ${userState.history.length}`);

                // 3ì¼ì¹˜ í•„í„°ë§
                const filtered = userState.history.filter(m => !m.timestamp || m.timestamp > threeDaysAgo);
                console.log(`ğŸš€ [ë””ë²„ê·¸] 3ì¼ ì´ë‚´ íˆìŠ¤í† ë¦¬ ê°œìˆ˜: ${filtered.length}`);

                const apiHistory = filtered.map(m => ({ role: m.role, parts: [{ text: m.text }] }));
                
                // [ë””ë²„ê·¸] ì‹¤ì œ ì „ì†¡ë˜ëŠ” ë°ì´í„° í™•ì¸
                console.log("ğŸš€ [ë””ë²„ê·¸] APIë¡œ ì „ì†¡ë  ë°ì´í„°:", apiHistory);

                if (apiHistory.length > 50) {
                    console.warn("âš ï¸ [ì£¼ì˜] ì „ì†¡í•  ëŒ€í™” ë‚´ì—­ì´ 50ê°œë¥¼ ë„˜ìŠµë‹ˆë‹¤. 429 ì›ì¸ì¼ ìˆ˜ ìˆìŒ.");
                }

                const genAI = new GoogleGenerativeAI(userState.apiKey);
                const model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "You are a helpful partner. Speak Korean."
                });

                // ì—¬ê¸°ì„œ 429ê°€ ëœ¨ëŠ”ì§€ í™•ì¸
                console.log("ğŸš€ [ë””ë²„ê·¸] model.startChat í˜¸ì¶œ ì‹œë„...");
                const chat = model.startChat({ history: apiHistory });
                console.log("âœ… [ë””ë²„ê·¸] model.startChat ì„±ê³µ!");

                el('chat-room-name-header').textContent = userState.persona.name;
                el('message-area').innerHTML = '';
                userState.history.forEach(m => displayMessage(m.role, m.text));
                
                showScreen('chat-screen');

                // ë©”ì‹œì§€ ì „ì†¡ ë¡œì§ (í´ë¡œì € ë¬¸ì œ ë°©ì§€ ìœ„í•´ ë‚´ë¶€ ì •ì˜)
                el('send-btn').onclick = async () => {
                    const txt = el('message-input').value;
                    if(!txt) return;
                    el('message-input').value = '';
                    displayMessage('user', txt);
                    
                    try {
                        console.log("ğŸš€ [ë””ë²„ê·¸] ë©”ì‹œì§€ ì „ì†¡ ì‹œë„:", txt);
                        const res = await chat.sendMessage(txt);
                        const reply = res.response.text();
                        console.log("âœ… [ë””ë²„ê·¸] ì‘ë‹µ ìˆ˜ì‹  ì„±ê³µ:", reply);
                        displayMessage('model', reply);
                        
                        // ì €ì¥
                        const ts = Date.now();
                        userState.history.push({ role: 'user', text: txt, timestamp: ts });
                        userState.history.push({ role: 'model', text: reply, timestamp: ts });
                        await setDoc(doc(db, 'users', userState.uid), { history: userState.history }, { merge: true });
                        
                    } catch(e) {
                        console.error("ğŸš¨ [ì¹˜ëª…ì  ì˜¤ë¥˜] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨ (429 ê°€ëŠ¥ì„±):", e);
                        alert(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}\n(ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”)`);
                    }
                };

            } catch(e) {
                console.error("ğŸš¨ [ì¹˜ëª…ì  ì˜¤ë¥˜] startChat ë‚´ë¶€ ì—ëŸ¬:", e);
                alert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ. API í‚¤ë‚˜ ë°ì´í„° ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                showScreen('setup-screen');
            }
        }

        // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸
        el('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        el('logout-btn').onclick = () => signOut(auth);
        
        el('start-chat-btn').onclick = async () => {
            userState.apiKey = el('api-key-input').value;
            userState.persona.name = el('persona-name-input').value;
            await setDoc(doc(db, 'users', userState.uid), { apiKey: userState.apiKey, persona: userState.persona }, { merge: true });
            startChatCount = 0; // ì¹´ìš´íŠ¸ ë¦¬ì…‹
            startChat();
        };

        el('reset-btn').onclick = async () => {
            if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (429 í•´ê²°ì±…)")) {
                await setDoc(doc(db, 'users', userState.uid), { apiKey: '', history: [], persona: {} });
                location.reload();
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                console.log("ğŸš€ [ë””ë²„ê·¸] ë¡œê·¸ì¸ ì„±ê³µ. ë°ì´í„° ë¡œë“œ ì‹œì‘.");
                userState.uid = user.uid;
                const snap = await getDoc(doc(db, 'users', user.uid));
                if(snap.exists()) {
                    const d = snap.data();
                    console.log("ğŸš€ [ë””ë²„ê·¸] Firestore ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", d);
                    userState.apiKey = d.apiKey;
                    userState.persona = d.persona || {};
                    userState.history = d.history || []; // ì—¬ê¸°ì„œ íˆìŠ¤í† ë¦¬ê°€ ì—„ì²­ í°ì§€ í™•ì¸

                    if(userState.apiKey && userState.persona.name) {
                        el('api-key-input').value = d.apiKey;
                        el('persona-name-input').value = d.persona.name;
                        startChat();
                    } else {
                        showScreen('setup-screen');
                    }
                } else {
                    showScreen('setup-screen');
                }
            } else {
                showScreen('login-screen');
            }
        });
    </script>
</body>
</html>