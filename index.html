<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect - AI Soulmate</title>
    
    <script>
        (function() {
            const userAgent = navigator.userAgent.toLowerCase();
            const targetUrl = location.href;
            if (userAgent.match(/kakaotalk|instagram|facebook|naver|line/i)) {
                if (userAgent.match(/android/i)) {
                    location.href = 'intent://' + targetUrl.replace(/https?:\/\//i, '') + '#Intent;scheme=https;package=com.android.chrome;end';
                }
            }
        })();
    </script>

    <style>
        /* =========================================
           CSS VARIABLES & THEME SETTINGS
           ========================================= */
        :root {
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            
            /* Light Mode Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f2f4f7;
            --text-primary: #1c1e21;
            --text-secondary: #65676b;
            --divider: #e4e6eb;
            
            /* Brand Colors */
            --accent-color: #8A2BE2; /* Deep Violet */
            --accent-hover: #7b1fa2;
            
            /* Chat Bubbles */
            --bubble-user: #9F7AEA; /* ì—°ë³´ë¼ìƒ‰ */
            --text-user: #ffffff;
            --bubble-partner: #ffffff;
            --text-partner: #1c1e21;
            
            /* UI Elements */
            --modal-bg: #ffffff;
            --danger-color: #ff4d4f;
            --shadow-card: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-float: 0 4px 12px rgba(0,0,0,0.15);
        }

        body.dark-mode {
            --bg-primary: #18191a;
            --bg-secondary: #000000;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --divider: #3e4042;
            --accent-color: #BB86FC;
            --bubble-user: #6B46C1;
            --bubble-partner: #242526;
            --text-partner: #e4e6eb;
            --modal-bg: #242526;
            --danger-color: #ff7875;
            --shadow-card: 0 2px 8px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            overflow: hidden;
            font-family: var(--font-main);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: 0.3s;
        }

        #app-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; flex-direction: column;
            max-width: 600px; margin: 0 auto;
            background-color: var(--bg-primary);
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .screen {
            display: none !important; flex-direction: column;
            height: 100%; width: 100%;
            position: absolute; top: 0; left: 0;
            background-color: var(--bg-primary);
            z-index: 10;
            animation: fadeIn 0.3s ease-in-out;
        }
        .screen.active { display: flex !important; z-index: 100; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* UI Components */
        .app-header {
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            padding: 0.8rem 1.2rem; border-bottom: 1px solid var(--divider);
            background: var(--bg-primary); height: 60px;
        }
        .header-title { font-size: 1.1rem; font-weight: 700; margin: 0; }

        .control-group { display: flex; gap: 8px; align-items: center; }
        .icon-btn {
            background: none; border: 1px solid var(--divider);
            border-radius: 8px; padding: 6px 10px;
            cursor: pointer; color: var(--text-secondary);
            font-size: 0.85rem; font-weight: 600;
        }

        .scroll-content { flex: 1; overflow-y: auto; padding: 20px; }
        .settings-card {
            background-color: var(--bg-primary);
            border: 1px solid var(--divider);
            border-radius: 16px; padding: 20px;
            margin-bottom: 20px; box-shadow: var(--shadow-card);
        }
        
        .input-group { margin-bottom: 15px; }
        .input-label {
            display: block; font-size: 0.85rem; font-weight: 600;
            color: var(--text-secondary); margin-bottom: 6px;
        }
        .text-input, .textarea-input {
            width: 100%; padding: 12px;
            border-radius: 10px; border: 1px solid var(--divider);
            background-color: var(--bg-primary); color: var(--text-primary);
            font-size: 1rem;
        }
        .textarea-input { min-height: 80px; resize: vertical; font-family: inherit; }

        .purple-hint-box {
            background-color: rgba(138, 43, 226, 0.08);
            border: 1px solid rgba(138, 43, 226, 0.2);
            color: var(--accent-color); padding: 15px;
            border-radius: 12px; text-align: center;
            font-size: 0.9rem; font-weight: 600;
            margin: 10px 0 20px 0; line-height: 1.5;
        }

        .primary-btn {
            display: block; width: 100%; padding: 14px;
            background-color: var(--accent-color); color: white;
            border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700;
            cursor: pointer; text-align: center; margin-top: 10px;
        }
        .danger-btn { background-color: var(--danger-color); margin-top: 10px; }
        
        .link-btn {
            background: none; border: none; color: var(--text-secondary);
            text-decoration: underline; font-size: 0.85rem; cursor: pointer; padding: 5px 0;
        }

        /* Chat Screen */
        .chat-header-profile { display: flex; align-items: center; }
        .chat-avatar-small {
            width: 40px; height: 40px; border-radius: 40%;
            object-fit: cover; margin-right: 12px;
            background-color: #ddd; border: 1px solid var(--divider);
        }
        
        #message-list {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            background-color: var(--bg-secondary);
        }

        .msg-row { display: flex; align-items: flex-end; margin-bottom: 5px; width: 100%; }
        .msg-row.me { flex-direction: row-reverse; }
        .partner-profile-col { display: flex; flex-direction: column; max-width: 75%; }
        .msg-avatar-tiny {
            width: 36px; height: 36px; border-radius: 40%;
            object-fit: cover; margin-right: 8px; flex-shrink: 0;
            background-color: #ccc; margin-bottom: auto;
        }
        .msg-name-label {
            font-size: 0.8rem; color: var(--text-secondary);
            margin-bottom: 4px; margin-left: 2px;
        }

        .msg-bubble {
            padding: 10px 14px; border-radius: 18px;
            font-size: 0.95rem; line-height: 1.5;
            word-wrap: break-word; white-space: pre-wrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative;
        }
        .msg-row.me .msg-bubble { background-color: var(--bubble-user); color: var(--text-user); border-top-right-radius: 4px; }
        .msg-row.partner .msg-bubble { background-color: var(--bubble-partner); color: var(--text-partner); border-top-left-radius: 4px; }
        .msg-bubble img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

        .msg-time {
            font-size: 0.65rem; color: var(--text-secondary);
            margin: 0 6px; white-space: nowrap; margin-bottom: 2px;
        }

        .date-divider {
            align-self: center; background-color: rgba(0,0,0,0.15);
            color: #fff; padding: 4px 12px; border-radius: 20px;
            font-size: 0.75rem; margin: 15px 0;
        }
        .dark-mode .date-divider { background-color: rgba(255,255,255,0.15); }

        .chat-input-area {
            flex-shrink: 0; display: flex; align-items: center; gap: 8px;
            padding: 10px 15px; background-color: var(--bg-primary);
            border-top: 1px solid var(--divider); position: relative;
        }
        #message-input {
            flex: 1; padding: 10px 15px; border-radius: 24px;
            border: 1px solid var(--divider); background-color: var(--bg-secondary);
            font-size: 1rem; color: var(--text-primary);
        }
        #send-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background-color: var(--accent-color); color: #fff;
            border: none; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
        }
        #plus-btn {
            font-size: 1.8rem; background: none; border: none;
            color: var(--text-secondary); cursor: pointer; padding: 0 5px; transition: 0.2s;
        }
        #plus-btn.active { transform: rotate(45deg); color: var(--accent-color); }

        .plus-menu-popup {
            position: absolute; bottom: 70px; left: 15px; width: 200px;
            background-color: var(--bg-primary); border-radius: 12px;
            box-shadow: var(--shadow-float); display: none;
            flex-direction: column; overflow: hidden;
            border: 1px solid var(--divider); z-index: 200;
        }
        .menu-item {
            padding: 15px; text-align: left; background: none; border: none;
            border-bottom: 1px solid var(--divider); color: var(--text-primary);
            font-size: 0.95rem; cursor: pointer;
        }
        .menu-item:hover { background-color: var(--bg-secondary); }

        .img-preview-box {
            display: none; padding: 10px; background: var(--bg-secondary);
            text-align: center; border-top: 1px solid var(--divider);
        }
        .img-preview-box.active { display: block; }
        .img-preview-box img { height: 80px; border-radius: 8px; }

        .loading-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--divider);
            border-top: 5px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="loading-screen" class="screen active">
            <div class="loading-container">
                <div class="spinner"></div>
                <h2 style="color: var(--accent-color); font-weight: 800;">Connect</h2>
                <p style="color: var(--text-secondary);">AI Soulmate</p>
            </div>
        </div>

        <div id="login-screen" class="screen">
            <div style="text-align: right; padding: 20px;">
                <button id="lang-toggle-login" class="icon-btn">EN</button>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 10px; color: var(--accent-color);">Connect</h1>
                <p data-i18n="appDescription" style="color: var(--text-secondary); margin-bottom: 40px; text-align: center; line-height: 1.5;">
                    ìµìˆ™í•œ ëŒ€í™”, ìƒ‰ë‹¤ë¥¸ ê³µê°.<br>ë‚˜ë§Œì˜ AI íŒŒíŠ¸ë„ˆ.
                </p>
                <button id="login-btn" class="primary-btn" data-i18n="loginBtn">Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <div id="setup-screen" class="screen">
            <header class="app-header">
                <h1 class="header-title" data-i18n="setupTitle">í”„ë¡œí•„ ì„¤ì •</h1>
                <div class="control-group">
                    <button id="lang-toggle-setup" class="icon-btn">EN</button>
                    <button id="theme-toggle-setup" class="icon-btn">ğŸŒ—</button>
                </div>
            </header>
            <div class="scroll-content">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img id="avatar-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" 
                         style="width: 100px; height: 100px; border-radius: 40%; object-fit: cover; border: 3px solid var(--divider); margin-bottom: 10px;">
                    <br>
                    <button id="avatar-upload-btn" class="icon-btn" data-i18n="uploadPhotoBtn">ì‚¬ì§„ ë³€ê²½</button>
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                </div>

                <div class="settings-card">
                    <div class="input-group">
                        <label class="input-label" data-i18n="personaNameLabel">ìƒëŒ€ë°© ì´ë¦„</label>
                        <input type="text" id="input-name" class="text-input" placeholder="ì˜ˆ: ì§€ìˆ˜">
                    </div>
                    <div class="input-group">
                        <label class="input-label" data-i18n="chatRoomNameLabel">ì±„íŒ…ë°© ì´ë¦„</label>
                        <input type="text" id="input-roomname" class="text-input" placeholder="ì˜ˆ: ë‚´ ì‚¬ë‘â™¡">
                    </div>
                </div>

                <div class="purple-hint-box" data-i18n="hintText">
                    * êµ¬ì²´ì ìœ¼ë¡œ ì ìœ¼ë©´ ë” ì‹¤ê°ë‚˜ìš”!<br>ê° í•­ëª©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”.
                </div>

                <div class="settings-card">
                    <div class="input-group">
                        <label class="input-label">ìê¸°ì†Œê°œ (ìƒí™©/ì»¨ì…‰)</label>
                        <textarea id="input-intro" class="textarea-input" placeholder="ì˜ˆ: ìš°ë¦¬ëŠ” 3ë…„ì°¨ ì»¤í”Œì´ê³ ..."></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ì„±ê²© ìŠ¤íƒ€ì¼</label>
                        <input type="text" id="input-style" class="text-input" placeholder="ì˜ˆ: ì• êµ ë§ê³  ë‹¤ì •í•œ">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ì—°ë½ ë¹ˆë„/ë‹µì¥ ì†ë„</label>
                        <input type="text" id="input-frequency" class="text-input" placeholder="ì˜ˆ: ì¹¼ë‹µ">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ëŒ€í™” ì„±í–¥</label>
                        <input type="text" id="input-tendency" class="text-input" placeholder="ì˜ˆ: ê³µê°ì„ ì˜í•´ì£¼ëŠ”">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ë‚˜ë¥¼ ë¶€ë¥¼ ì• ì¹­</label>
                        <input type="text" id="input-nickname" class="text-input" placeholder="ì˜ˆ: ìê¸°ì•¼">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ìƒëŒ€ë°© ë‚˜ì´</label>
                        <input type="text" id="input-age" class="text-input" placeholder="ì˜ˆ: 24">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Google AI Studio API Key</label>
                        <input type="password" id="input-apikey" class="text-input" placeholder="API Key ì…ë ¥">
                        <button id="guide-apikey-btn" class="link-btn">í‚¤ ë°œê¸‰ ë°©ë²•</button>
                    </div>
                </div>

                <button id="start-chat-btn" class="primary-btn" data-i18n="startChatBtn">ëŒ€í™” ì‹œì‘í•˜ê¸°</button>
                <button id="reset-data-btn" class="primary-btn danger-btn" data-i18n="resetBtn">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div id="chat-screen" class="screen">
            <header class="app-header">
                <div class="chat-header-profile">
                    <img id="header-avatar" class="chat-avatar-small" src="">
                    <h1 id="header-roomname" class="header-title"></h1>
                </div>
                <div class="control-group">
                    <button id="theme-toggle-chat" class="icon-btn">ğŸŒ—</button>
                    <button id="logout-btn" class="icon-btn" data-i18n="logoutBtn">ë‚˜ê°€ê¸°</button>
                </div>
            </header>

            <main id="message-list"></main>

            <div id="img-preview" class="img-preview-box">
                <img id="preview-element" src="">
                <button id="cancel-img-btn" class="icon-btn" style="margin-top:5px;">ì·¨ì†Œ</button>
            </div>

            <div id="plus-menu" class="plus-menu-popup">
                <button class="menu-item" id="menu-photo">ğŸ“· ì‚¬ì§„ ë³´ë‚´ê¸°</button>
                <button class="menu-item" id="menu-settings">âš™ï¸ í”„ë¡œí•„ ì„¤ì • ë³€ê²½</button>
            </div>

            <footer class="chat-input-area">
                <button id="plus-btn">+</button>
                <input type="file" id="chat-file-input" accept="image/*" style="display: none;">
                <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
                <button id="send-btn">â¤</button>
            </footer>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const firebaseConfig = {
            apiKey: "AIzaSyDmO1wpZQJEiPEjNoq7xtFcq33akIzoGY8",
            authDomain: "aimeet-c235c.firebaseapp.com",
            projectId: "aimeet-c235c",
            appId: "1:732324287861:web:15d894068755c627842f3c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ëª¨ë¸ ì„¤ì •
        const MAIN_MODEL = "gemma-3-4b-it";
        const BACKUP_MODEL = "gemini-2.5-flash-lite";
        const TPM_THRESHOLD = 15000 * 0.75; 

        // ë‹¤êµ­ì–´
        const I18N = {
            en: {
                appDescription: 'Familiar conversations,\nYour own AI Partner.',
                loginBtn: 'Start with Google',
                setupTitle: 'Profile Setup',
                personaNameLabel: 'Partner Name',
                chatRoomNameLabel: 'Chat Title',
                hintText: '* More details make the AI more realistic!',
                startChatBtn: 'Start Chat',
                resetBtn: 'Reset All Data',
                logoutBtn: 'Logout',
                uploadPhotoBtn: 'Change Photo'
            },
            ko: {
                appDescription: 'ìµìˆ™í•œ ëŒ€í™”, ìƒ‰ë‹¤ë¥¸ ê³µê°.<br>ë‚˜ë§Œì˜ AI íŒŒíŠ¸ë„ˆ.',
                loginBtn: 'Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°',
                setupTitle: 'í”„ë¡œí•„ ì„¤ì •',
                personaNameLabel: 'ìƒëŒ€ë°© ì´ë¦„',
                chatRoomNameLabel: 'ì±„íŒ…ë°© ì´ë¦„',
                hintText: '* êµ¬ì²´ì ìœ¼ë¡œ ì ìœ¼ë©´ ë” ì‹¤ê°ë‚˜ìš”!<br>ê° í•­ëª©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”.',
                startChatBtn: 'ëŒ€í™” ì‹œì‘í•˜ê¸°',
                resetBtn: 'ë°ì´í„° ì´ˆê¸°í™”',
                logoutBtn: 'ë‚˜ê°€ê¸°',
                uploadPhotoBtn: 'ì‚¬ì§„ ë³€ê²½'
            }
        };

        // ìƒíƒœ ê´€ë¦¬
        const state = {
            user: null,
            lang: 'ko',
            apiKey: '',
            persona: {},
            chatHistory: [],
            visualHistory: [],
            longTermMemory: "",
            currentTPM: 0,
            chatSession: null,
            pendingImage: null,
            lastDateStr: null,
            lastMsgTime: Date.now()
        };

        const el = (id) => document.getElementById(id);

        function init() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.user = user;
                    loadUserData();
                } else {
                    showScreen('login-screen');
                }
            });

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            el('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
            el('logout-btn').onclick = () => signOut(auth);
            
            el('avatar-upload-btn').onclick = () => el('avatar-input').click();
            el('avatar-input').onchange = (e) => processImage(e.target.files[0], 'avatar');
            
            el('start-chat-btn').onclick = saveAndStart;
            el('reset-data-btn').onclick = resetData;
            
            el('send-btn').onclick = handleUserMessage;
            el('message-input').onkeydown = (e) => { if(e.key === 'Enter') handleUserMessage(); };
            
            el('plus-btn').onclick = togglePlusMenu;
            el('menu-photo').onclick = () => { el('chat-file-input').click(); togglePlusMenu(); };
            el('menu-settings').onclick = () => { showScreen('setup-screen'); togglePlusMenu(); };
            el('chat-file-input').onchange = (e) => processImage(e.target.files[0], 'chat');
            el('cancel-img-btn').onclick = clearPendingImage;

            el('lang-toggle-login').onclick = toggleLang;
            el('lang-toggle-setup').onclick = toggleLang;
            el('theme-toggle-setup').onclick = toggleTheme;
            el('theme-toggle-chat').onclick = toggleTheme;
            
            startSunTokLoop();
            updateUI(); // ì´ˆê¸° UI í…ìŠ¤íŠ¸ ì„¤ì •
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            el(id).classList.add('active');
            if(id === 'chat-screen') scrollToBottom();
        }

        async function loadUserData() {
            const snap = await getDoc(doc(db, 'users', state.user.uid));
            if (snap.exists()) {
                const d = snap.data();
                state.apiKey = d.apiKey || '';
                state.persona = d.persona || {};
                state.chatHistory = d.chatHistory || [];
                state.visualHistory = d.visualHistory || [];
                state.longTermMemory = d.longTermMemory || "";
                
                fillInputs();
                
                if (state.apiKey && state.persona.name) {
                    initChatSession();
                } else {
                    showScreen('setup-screen');
                }
            } else {
                showScreen('setup-screen');
            }
        }

        function fillInputs() {
            el('input-apikey').value = state.apiKey;
            el('input-name').value = state.persona.name || '';
            el('input-roomname').value = state.persona.chatRoomName || '';
            el('input-intro').value = state.persona.intro || '';
            el('input-style').value = state.persona.style || '';
            el('input-frequency').value = state.persona.frequency || '';
            el('input-tendency').value = state.persona.tendency || '';
            el('input-nickname').value = state.persona.nickname || '';
            el('input-age').value = state.persona.age || '';
            el('avatar-preview').src = state.persona.avatar || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
        }

        async function saveAndStart() {
            state.apiKey = el('input-apikey').value.trim();
            state.persona = {
                name: el('input-name').value,
                chatRoomName: el('input-roomname').value,
                intro: el('input-intro').value,
                style: el('input-style').value,
                frequency: el('input-frequency').value,
                tendency: el('input-tendency').value,
                nickname: el('input-nickname').value,
                age: el('input-age').value,
                avatar: el('avatar-preview').src
            };

            await setDoc(doc(db, 'users', state.user.uid), {
                apiKey: state.apiKey,
                persona: state.persona
            }, { merge: true });

            initChatSession();
        }

        async function initChatSession() {
            el('header-roomname').textContent = state.persona.chatRoomName;
            el('header-avatar').src = state.persona.avatar;
            el('message-list').innerHTML = '';
            state.lastDateStr = null;

            state.visualHistory.forEach(msg => renderMessageUI(msg));

            // ë‹¨ê¸° ê¸°ì–µ ë³´í˜¸: ìµœê·¼ 20ê°œëŠ” ì ˆëŒ€ ìš”ì•½ ì•ˆí•¨ (í‹°í‚¤íƒ€ì¹´ ìœ ì§€)
            // 20ê°œ ë„˜ì–´ê°€ë©´ ì˜¤ë˜ëœ ê²ƒë§Œ ìš”ì•½
            if (state.chatHistory.length > 20) {
                await compressMemory();
            }

            const systemPrompt = `
            [ROLE] ë‹¹ì‹ ì€ '${state.persona.name}' (${state.persona.age}ì„¸)ì…ë‹ˆë‹¤.
            [RELATION] ${state.persona.chatRoomName}
            [PERSONALITY] ${state.persona.style}, ${state.persona.tendency}
            [CONTEXT] ${state.persona.intro}
            [USER] ${state.persona.nickname}
            [LONG TERM MEMORY] ${state.longTermMemory}
            
            [RULES]
            1. ë¬´ì¡°ê±´ ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ ë°˜ë§(ì¹´í†¡ì²´)ì„ ì‚¬ìš©í•˜ì„¸ìš”.
            2. ë‹¹ì‹ ì€ AIì´ì§€ë§Œ, í‹°ë¥¼ ë‚´ì§€ ë§ˆì„¸ìš”. ë‹¨, ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•œ ì•½ì†(ë§Œë‚˜ì, ì‚¬ê°ˆê²Œ)ì€ í”¼í•˜ì„¸ìš”.
            3. ì´ëª¨ì§€ëŠ” ë¬¸ì¥ì˜ ë§¨ ëì— ìµœëŒ€ 1ê°œë§Œ ë¶™ì´ì„¸ìš”. (ë‚¨ë°œ ê¸ˆì§€)
            4. ë‹µë³€ì€ 1~3ë¬¸ì¥ ë‚´ì™¸ë¡œ ì§§ê²Œ í•˜ì„¸ìš”.
            `;

            // ìµœê·¼ 20ê°œ ëŒ€í™”ëŠ” ì›ë³¸ ê·¸ëŒ€ë¡œ ì£¼ì…
            const recentHistory = state.chatHistory.slice(-20);
            const historyWithSystem = [
                { role: 'user', parts: [{ text: systemPrompt }] },
                { role: 'model', parts: [{ text: "ì‘, ì•Œê² ì–´. ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í• ê²Œ." }] },
                ...recentHistory
            ];

            try {
                const genAI = new GoogleGenerativeAI(state.apiKey);
                // TPM ê¸°ë°˜ í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë¸ ì„ íƒ
                const modelName = (state.currentTPM > TPM_THRESHOLD) ? BACKUP_MODEL : MAIN_MODEL;
                const model = genAI.getGenerativeModel({ model: modelName });
                
                state.chatSession = model.startChat({ history: historyWithSystem });
                showScreen('chat-screen');

                // ëŒ€í™” ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì²« ì¸ì‚¬ íŠ¸ë¦¬ê±°
                if (state.visualHistory.length === 0) {
                    triggerAIResponse("ìƒí™©ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì²« ì¸ì‚¬ë¥¼ ê±´ë„¤ì¤˜ (ì§§ê²Œ)");
                }

            } catch (e) {
                alert("API Error: " + e.message);
                showScreen('setup-screen');
            }
        }

        async function compressMemory() {
            const genAI = new GoogleGenerativeAI(state.apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-lite" });
            
            // ê°€ì¥ ì˜¤ë˜ëœ 10ê°œë§Œ ìš”ì•½
            const toSummarize = state.chatHistory.slice(0, 10);
            const prompt = `ë‹¤ìŒ ëŒ€í™” ë‚´ìš©ì„ 'ì£¼ìš” ì‚¬ê±´, ìœ ì €ì˜ ê¸°ë¶„, ëŒ€í™” ì£¼ì œ' ìœ„ì£¼ë¡œ í•œ ì¤„ë¡œ ìš”ì•½í•´: ${JSON.stringify(toSummarize)}`;
            
            try {
                const res = await model.generateContent(prompt);
                const summary = res.response.text();
                state.longTermMemory += ` / ${summary}`;
                // ìš”ì•½ëœ 10ê°œ ì‚­ì œ
                state.chatHistory = state.chatHistory.slice(10);
            } catch (e) {
                console.error("Summary Failed", e);
            }
        }

        async function handleUserMessage() {
            const txt = el('message-input').value.trim();
            const img = state.pendingImage;
            
            if (!txt && !img) return;
            
            el('message-input').value = '';
            clearPendingImage();

            const now = Date.now();
            const userMsg = { role: 'user', text: txt, image: img, timestamp: now };
            renderMessageUI(userMsg);
            
            state.visualHistory.push(userMsg);
            
            let apiPart = { text: txt };
            state.chatHistory.push({ role: 'user', parts: [apiPart] });
            
            state.currentTPM += txt.length;
            
            await triggerAIResponse(txt);
        }

        async function triggerAIResponse(userText) {
            displayTyping(true);
            try {
                const result = await state.chatSession.sendMessage(userText);
                const rawText = result.response.text();
                const processedText = cleanAIResponse(rawText);
                
                displayTyping(false);
                
                const now = Date.now();
                const aiMsg = { role: 'model', text: processedText, timestamp: now };
                
                renderMessageUI(aiMsg);
                state.visualHistory.push(aiMsg);
                state.chatHistory.push({ role: 'model', parts: [{ text: processedText }] });
                
                state.lastMsgTime = now;
                saveData();

            } catch (e) {
                displayTyping(false);
                console.error(e);
            }
        }

        function cleanAIResponse(text) {
            let clean = text.replace(/(\*\*|System:|User:|Model:)/gi, "").trim();
            const emojiRegex = /[\u{1F300}-\u{1F9FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu;
            let emojis = clean.match(emojiRegex) || [];
            clean = clean.replace(emojiRegex, '').trim();
            
            if (emojis.length > 0) {
                clean += " " + emojis[0];
            }
            return clean;
        }

        function renderMessageUI(msg) {
            const list = el('message-list');
            const date = new Date(msg.timestamp);
            const dateStr = date.toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric', weekday:'long'});
            
            if (state.lastDateStr !== dateStr) {
                const div = document.createElement('div');
                div.className = 'date-divider';
                div.textContent = dateStr;
                list.appendChild(div);
                state.lastDateStr = dateStr;
            }

            const row = document.createElement('div');
            row.className = `msg-row ${msg.role === 'user' ? 'me' : 'partner'}`;
            
            if (msg.role === 'model') {
                const col = document.createElement('div');
                col.className = 'partner-profile-col';
                
                const av = document.createElement('img');
                av.className = 'msg-avatar-tiny';
                av.src = state.persona.avatar;
                
                const name = document.createElement('span');
                name.className = 'msg-name-label';
                name.textContent = state.persona.name;
                
                const bubble = createBubble(msg.text, msg.image, false);
                col.appendChild(name);
                col.appendChild(bubble);
                row.appendChild(av);
                row.appendChild(col);
                row.appendChild(createTimeElement(date));
            } else {
                const bubble = createBubble(msg.text, msg.image, true);
                row.appendChild(createTimeElement(date));
                row.appendChild(bubble);
            }

            list.appendChild(row);
            scrollToBottom();
        }

        function createBubble(text, imageBase64, isUser) {
            const b = document.createElement('div');
            b.className = 'msg-bubble';
            if (imageBase64) {
                const img = document.createElement('img');
                img.src = imageBase64;
                b.appendChild(img);
            }
            if (text) {
                const span = document.createElement('span');
                span.textContent = text;
                b.appendChild(span);
            }
            return b;
        }

        function createTimeElement(date) {
            const t = document.createElement('span');
            t.className = 'msg-time';
            t.textContent = date.toLocaleTimeString('ko-KR', { hour:'numeric', minute:'2-digit', hour12:true });
            return t;
        }

        function displayTyping(show) {
            const existing = document.getElementById('typing-indicator');
            if (existing) existing.remove();
            
            if (show) {
                const list = el('message-list');
                const row = document.createElement('div');
                row.id = 'typing-indicator';
                row.className = 'msg-row partner';
                row.innerHTML = `
                    <img class="msg-avatar-tiny" src="${state.persona.avatar}">
                    <div class="msg-bubble" style="background:var(--bubble-partner); color:var(--text-partner);">...</div>
                `;
                list.appendChild(row);
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const list = el('message-list');
            list.scrollTop = list.scrollHeight;
        }

        function processImage(file, type) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                if (type === 'avatar') {
                    el('avatar-preview').src = base64;
                } else {
                    state.pendingImage = base64;
                    el('preview-element').src = base64;
                    el('img-preview').classList.add('active');
                }
            };
            reader.readAsDataURL(file);
        }

        function clearPendingImage() {
            state.pendingImage = null;
            el('img-preview').classList.remove('active');
            el('chat-file-input').value = '';
        }

        function togglePlusMenu() {
            const m = el('plus-menu');
            const btn = el('plus-btn');
            const isActive = m.style.display === 'flex';
            m.style.display = isActive ? 'none' : 'flex';
            if (isActive) btn.classList.remove('active');
            else btn.classList.add('active');
        }

        function toggleLang() {
            state.lang = (state.lang === 'ko') ? 'en' : 'ko';
            updateUI();
        }

        function updateUI() {
            el('lang-toggle-login').textContent = state.lang === 'ko' ? 'EN' : 'KR';
            el('lang-toggle-setup').textContent = state.lang === 'ko' ? 'EN' : 'KR';
            
            const t = I18N[state.lang];
            document.querySelectorAll('[data-i18n]').forEach(elem => {
                const key = elem.dataset.i18n;
                if (t[key]) elem.innerHTML = t[key];
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        async function saveData() {
            if (!state.user) return;
            await setDoc(doc(db, 'users', state.user.uid), {
                chatHistory: state.chatHistory,
                visualHistory: state.visualHistory,
                longTermMemory: state.longTermMemory
            }, { merge: true });
        }

        async function resetData() {
            if (!confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            state.chatHistory = [];
            state.visualHistory = [];
            state.longTermMemory = "";
            state.persona = {};
            state.apiKey = "";
            await setDoc(doc(db, 'users', state.user.uid), {
                chatHistory: [], visualHistory: [], longTermMemory: "", persona: {}, apiKey: ""
            });
            location.reload();
        }

        function startSunTokLoop() {
            setInterval(async () => {
                if (!state.chatSession) return;
                const diffMin = (Date.now() - state.lastMsgTime) / 60000;
                // 20~40ë¶„ ëœë¤ íŠ¸ë¦¬ê±°
                if (diffMin > (Math.random() * 20 + 20)) {
                    triggerAIResponse("ìœ ì €ê°€ ë‹µì¥ì´ ëŠ¦ë„¤. ì„œìš´í•œ í‹°ë¥¼ ë‚´ë©´ì„œ ì„ í†¡í•´ì¤˜.");
                }
            }, 60000);
        }

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>