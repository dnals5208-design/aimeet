<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Connect Manual Debugger</title>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; line-height: 1.5; }
        h1 { color: #fff; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .control-panel { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #555; }
        
        input { background: #000; color: #fff; border: 1px solid #555; padding: 10px; width: 300px; margin-right: 10px; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; background: #444; color: #fff; border: 1px solid #fff; }
        button:hover { background: #666; }
        button.primary { background: #007bff; border-color: #007bff; }
        button.danger { background: #dc3545; border-color: #dc3545; }

        #log-area { 
            width: 100%; height: 500px; background: #000; border: 1px solid #555; 
            overflow-y: scroll; padding: 10px; white-space: pre-wrap; 
        }
        .log-time { color: #888; margin-right: 10px; }
        .log-error { color: #ff5555; font-weight: bold; }
        .log-success { color: #55ff55; }
        .log-warn { color: #ffff55; }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ API í‚¤ ì§ì ‘ ì…ë ¥ ë””ë²„ê±°</h1>
    
    <div class="control-panel">
        <h3>1. ë¡œê·¸ì¸ & í‚¤ ì„¤ì •</h3>
        <button id="login-btn">êµ¬ê¸€ ë¡œê·¸ì¸</button>
        <br><br>
        <label>API KEY: </label>
        <input type="text" id="manual-api-key" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
        <button id="save-key-btn">í‚¤ ì €ì¥(DB)</button>
    </div>

    <div class="control-panel">
        <h3>2. API ì—°ê²° í…ŒìŠ¤íŠ¸</h3>
        <button id="check-history-btn">ì €ì¥ëœ ëŒ€í™”ëŸ‰ í™•ì¸</button>
        <button id="test-api-btn" class="primary">ë‹¨ìˆœ ì—°ê²° í…ŒìŠ¤íŠ¸ (ì•ˆë…•?)</button>
        <button id="reset-db-btn" class="danger">DB ì´ˆê¸°í™” (429 í•´ê²°ìš©)</button>
    </div>

    <div id="log-area">ë¡œê·¸ ëŒ€ê¸°ì¤‘...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // Firebase ì„¤ì •
        const firebaseConfig = { apiKey: "AIzaSyDmO1wpZQJEiPEjNoq7xtFcq33akIzoGY8", authDomain: "aimeet-c235c.firebaseapp.com", projectId: "aimeet-c235c", appId: "1:732324287861:web:15d894068755c627842f3c" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;

        // ë¡œê¹… í•¨ìˆ˜
        const logArea = document.getElementById('log-area');
        function log(msg, type = '') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${msg}</span>`;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(msg);
        }

        // 1. ë¡œê·¸ì¸
        document.getElementById('login-btn').onclick = () => {
            signInWithPopup(auth, new GoogleAuthProvider())
                .then(res => log(`âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${res.user.uid}`, 'success'))
                .catch(e => log(`ğŸ›‘ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.message}`, 'error'));
        };

        // Auth ìƒíƒœ ê°ì§€ & í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                log(`â„¹ï¸ ì‚¬ìš©ì ê°ì§€ë¨: ${user.uid}`);
                
                try {
                    const snap = await getDoc(doc(db, 'users', user.uid));
                    if (snap.exists()) {
                        const data = snap.data();
                        if (data.apiKey) {
                            document.getElementById('manual-api-key').value = data.apiKey;
                            log(`ğŸ“‚ DBì—ì„œ API í‚¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
                        } else {
                            log(`âš ï¸ DBì— API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.`, 'warn');
                        }
                    }
                } catch (e) {
                    log(`ğŸ›‘ DB ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
            }
        });

        // í‚¤ ì €ì¥
        document.getElementById('save-key-btn').onclick = async () => {
            const key = document.getElementById('manual-api-key').value.trim();
            if (!currentUser) return log("ğŸ›‘ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", 'error');
            if (!key) return log("ğŸ›‘ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');

            try {
                await setDoc(doc(db, 'users', currentUser.uid), { apiKey: key }, { merge: true });
                log("âœ… API í‚¤ê°€ DBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success');
            } catch (e) {
                log(`ğŸ›‘ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            }
        };

        // ëŒ€í™”ëŸ‰ í™•ì¸ (429 ì›ì¸ ë¶„ì„)
        document.getElementById('check-history-btn').onclick = async () => {
            if (!currentUser) return log("ğŸ›‘ ë¡œê·¸ì¸ í•„ìš”", 'error');
            const snap = await getDoc(doc(db, 'users', currentUser.uid));
            if (snap.exists()) {
                const history = snap.data().chatHistory || [];
                const jsonStr = JSON.stringify(history);
                log(`ğŸ“Š í˜„ì¬ ì €ì¥ëœ ëŒ€í™” ê°œìˆ˜: ${history.length}ê°œ`);
                log(`âš–ï¸ ë°ì´í„° í¬ê¸°(ê¸€ììˆ˜): ì•½ ${jsonStr.length}ì`);
                
                if (jsonStr.length > 30000) {
                    log(`ğŸ”¥ [ê²½ê³ ] ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤! ì´ê²ƒ ë•Œë¬¸ì— 429ê°€ ëœ° í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤.`, 'error');
                } else {
                    log(`ğŸ‘ ë°ì´í„° í¬ê¸°ëŠ” ì ë‹¹í•©ë‹ˆë‹¤.`, 'success');
                }
            }
        };

        // API ì—°ê²° í…ŒìŠ¤íŠ¸
        document.getElementById('test-api-btn').onclick = async () => {
            const key = document.getElementById('manual-api-key').value.trim();
            if (!key) return log("ğŸ›‘ ì…ë ¥ì°½ì— API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.", 'error');

            log("ğŸš€ [í…ŒìŠ¤íŠ¸ ì‹œì‘] Google ì„œë²„ì— 'ì•ˆë…•'ì´ë¼ê³  ë³´ë‚´ë´…ë‹ˆë‹¤...");

            try {
                const genAI = new GoogleGenerativeAI(key);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                
                // íˆìŠ¤í† ë¦¬ ì—†ì´ ë‹¨ë°œì„± ì „ì†¡ í…ŒìŠ¤íŠ¸ (ì´ê²Œ ë˜ë©´ í‚¤ëŠ” ì •ìƒ)
                const result = await model.generateContent("ì•ˆë…•? ì§§ê²Œ ëŒ€ë‹µí•´ì¤˜.");
                const response = await result.response;
                const text = response.text();
                
                log(`âœ… [ì„±ê³µ] ì‘ë‹µ: ${text}`, 'success');
                log(`ğŸ‘‰ í‚¤ëŠ” ì •ìƒì…ë‹ˆë‹¤. 429ê°€ ëœ¬ë‹¤ë©´ 'ëŒ€í™” ë‚´ì—­(History)' ë¬¸ì œì…ë‹ˆë‹¤.`, 'info');

            } catch (e) {
                log(`ğŸ›‘ [ì‹¤íŒ¨] ì˜¤ë¥˜ ë‚´ìš©:`, 'error');
                log(e.toString(), 'error');
                if (e.message.includes('429')) {
                    log(`ğŸš¨ 429 (Too Many Requests) í™•ì¸ë¨!`, 'error');
                    log(`í•´ê²°ì±…: 'DB ì´ˆê¸°í™”' ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³¼ê±° ê¸°ë¡ì„ ë‚ ë ¤ë³´ì„¸ìš”.`, 'warn');
                }
            }
        };

        // DB ì´ˆê¸°í™”
        document.getElementById('reset-db-btn').onclick = async () => {
            if (!currentUser) return;
            if (confirm("ì •ë§ ëª¨ë“  ëŒ€í™” ë‚´ìš©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (429 í•´ê²° ì§ë¹µ)")) {
                await setDoc(doc(db, 'users', currentUser.uid), { chatHistory: [], visualHistory: [], apiKey: document.getElementById('manual-api-key').value }, { merge: true });
                log("ğŸ—‘ï¸ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.", 'success');
            }
        };
    </script>
</body>
</html>