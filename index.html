<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Connect DEBUG MODE</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        #debug-console { 
            width: 100%; height: 300px; background: #000; color: #0f0; 
            font-family: monospace; padding: 10px; overflow-y: scroll; 
            border-radius: 8px; margin-bottom: 20px; font-size: 12px;
        }
        .log-line { margin: 2px 0; border-bottom: 1px solid #333; }
        .error { color: #ff5555; font-weight: bold; }
        .warn { color: #ffaa00; }
        .info { color: #00aaff; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ 429 ì˜¤ë¥˜ ì¶”ì  ë””ë²„ê±°</h1>
    <p>ì•„ë˜ ê²€ì€ í™”ë©´ì— ëœ¨ëŠ” ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
    
    <div id="debug-console"></div>
    
    <div id="app-ui">
        <button id="login-btn">1. êµ¬ê¸€ ë¡œê·¸ì¸</button>
        <button id="start-btn">2. ì±„íŒ… ì‹œì‘ (API ì—°ê²°)</button>
        <button id="send-test-btn">3. í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡</button>
        <button id="reset-btn" style="background:red; color:white;">ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // --- ë””ë²„ê·¸ ë¡œê·¸ í•¨ìˆ˜ ---
        const debugEl = document.getElementById('debug-console');
        function log(msg, type = 'normal') {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            debugEl.appendChild(line);
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(msg); // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ë„ ì¶œë ¥
        }

        // --- Firebase ì„¤ì • ---
        const firebaseConfig = { apiKey: "AIzaSyDmO1wpZQJEiPEjNoq7xtFcq33akIzoGY8", authDomain: "aimeet-c235c.firebaseapp.com", projectId: "aimeet-c235c", appId: "1:732324287861:web:15d894068755c627842f3c" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userState = { uid: null, apiKey: null, persona: {}, history: [] };
        let chatInstance = null;

        // 1. ë¡œê·¸ì¸
        document.getElementById('login-btn').onclick = () => {
            log("ğŸ‘‰ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨");
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => log(`ğŸ›‘ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.message}`, 'error'));
        };

        // 2. Auth ìƒíƒœ ê°ì§€
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userState.uid = user.uid;
                log(`âœ… ë¡œê·¸ì¸ ì„±ê³µ (UID: ${user.uid.slice(0, 5)}...)`, 'info');
                
                // ë°ì´í„° ë¡œë“œ
                try {
                    const snap = await getDoc(doc(db, 'users', user.uid));
                    if (snap.exists()) {
                        const data = snap.data();
                        userState.apiKey = data.apiKey;
                        userState.history = data.chatHistory || [];
                        userState.persona = data.persona || {};
                        
                        log(`ğŸ“‚ Firestore ë°ì´í„° ë¡œë“œ ì™„ë£Œ`, 'info');
                        log(`   - API Key ì¡´ì¬ ì—¬ë¶€: ${userState.apiKey ? 'O' : 'X'}`, userState.apiKey ? 'info' : 'error');
                        log(`   - ì €ì¥ëœ ëŒ€í™” ê°œìˆ˜: ${userState.history.length}ê°œ`, 'info');
                    } else {
                        log(`ğŸ“‚ ì‹ ê·œ ìœ ì €ì…ë‹ˆë‹¤. ë°ì´í„° ì—†ìŒ.`);
                    }
                } catch (e) {
                    log(`ğŸ›‘ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error');
                }
            } else {
                log(`â„¹ï¸ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ`);
            }
        });

        // 3. ì±„íŒ… ì‹œì‘ (ì—¬ê¸°ê°€ 429 í•µì‹¬ êµ¬ê°„)
        document.getElementById('start-btn').onclick = async () => {
            if (!userState.apiKey) {
                log("ğŸ›‘ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'error');
                return;
            }

            log("ğŸš€ [API ì—°ê²° ì‹œë„] startChat ì‹¤í–‰");

            try {
                const genAI = new GoogleGenerativeAI(userState.apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

                // [ë°ì´í„° í•„í„°ë§ ê²€ì¦]
                const now = Date.now();
                const threeDaysAgo = now - (3 * 24 * 60 * 60 * 1000);
                
                log(`ğŸ“‰ 3ì¼ì¹˜ ë°ì´í„° í•„í„°ë§ ì‹œì‘... (ê¸°ì¤€: ${new Date(threeDaysAgo).toLocaleString()})`);
                
                const filteredHistory = userState.history.filter(m => {
                    // íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ìœ¼ë©´(ì˜›ë‚  ë°ì´í„°) í¬í•¨, ìˆìœ¼ë©´ 3ì¼ ì´ë‚´ë§Œ í¬í•¨
                    return !m.timestamp || m.timestamp > threeDaysAgo;
                }).map(m => ({
                    role: m.role,
                    parts: [{ text: m.text }]
                }));

                log(`   - í•„í„°ë§ ì „: ${userState.history.length}ê°œ`);
                log(`   - í•„í„°ë§ í›„: ${filteredHistory.length}ê°œ`, 'warn');

                // í† í° ëŸ‰ ëŒ€ëµì  ê³„ì‚° (ê¸€ììˆ˜)
                const totalChars = JSON.stringify(filteredHistory).length;
                log(`   - ì „ì†¡ ë°ì´í„° í¬ê¸°(ì˜ˆìƒ): ì•½ ${totalChars}ì`);

                if (totalChars > 30000) {
                    log(`ğŸ›‘ [ê²½ê³ ] ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤! 429 ì›ì¸ ê°€ëŠ¥ì„± ë†’ìŒ.`, 'error');
                }

                // ì‹¤ì œ ì—°ê²°
                log("ğŸ“¡ Google ì„œë²„ë¡œ startChat ìš”ì²­ ì „ì†¡ ì¤‘...");
                chatInstance = model.startChat({ history: filteredHistory });
                
                // í…ŒìŠ¤íŠ¸ í˜¸ì¶œ (ë¹ˆ ë©”ì‹œì§€ ì•ˆ ë³´ëƒ„, ì—°ê²°ë§Œ í™•ì¸)
                log("âœ… model.startChat ê°ì²´ ìƒì„± ì„±ê³µ (ì•„ì§ 429 ì•„ë‹˜)");
                log("ğŸ‘‰ ì´ì œ 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.");

            } catch (e) {
                log(`ğŸ›‘ startChat ì´ˆê¸°í™” ì¤‘ ì—ëŸ¬: ${e.message}`, 'error');
            }
        };

        // 4. ë©”ì‹œì§€ ì „ì†¡ í…ŒìŠ¤íŠ¸
        document.getElementById('send-test-btn').onclick = async () => {
            if (!chatInstance) {
                log("ğŸ›‘ ë¨¼ì € 'ì±„íŒ… ì‹œì‘'ì„ ëˆŒëŸ¬ ì—°ê²°í•˜ì„¸ìš”.", 'error');
                return;
            }
            
            const msg = "ì•ˆë…• ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ì•¼";
            log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„: "${msg}"`);
            
            try {
                const result = await chatInstance.sendMessage(msg);
                const text = result.response.text();
                log(`ğŸ“¥ ì‘ë‹µ ìˆ˜ì‹  ì„±ê³µ: "${text.slice(0, 30)}..."`, 'info');
            } catch (e) {
                log(`ğŸ›‘ [429 ì˜¤ë¥˜ ë°œìƒ ì§€ì ] ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:`, 'error');
                log(e.toString(), 'error');
                if (e.message.includes('429')) {
                    log("ğŸš¨ 429 í™•ì¸ë¨! ìš”ì²­ì´ ë„ˆë¬´ ë§ê±°ë‚˜ ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.", 'error');
                }
            }
        };

        // ì´ˆê¸°í™”
        document.getElementById('reset-btn').onclick = async () => {
            if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ë‚ ë¦½ë‹ˆë‹¤. í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await setDoc(doc(db, 'users', userState.uid), { apiKey: '', chatHistory: [], persona: {} });
                location.reload();
            }
        }
    </script>
</body>
</html>
